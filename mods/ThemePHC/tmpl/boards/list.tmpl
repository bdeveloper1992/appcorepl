	<!--<a_cssx src="%%modpath%%/css/boards.css"/>-->
	
	<tmpl_if is_mobile>
	<a:cssx src="%%appcore%%/mods/ThemePHC/css/boards-list-mobile.css"/>
	<tmpl_else>
	<a:cssx src="%%appcore%%/mods/ThemePHC/css/boards-list.css"/>
	</tmpl_if>
	<!--<a_cssx src="%%appcore%%/js/jquery.qtip.min.css"/>-->
	
	<title><tmpl_var board_title> - Bulletin Boards</title>
	
	<!-- Board Title -->
	<h1 class='page_title'><tmpl_var board_title></h1>
	<!--<h1>
	%%binpath%%/%%board_folder_name%%/post
	</h1>-->
	
	<script>
	// Using the ${CDN:...} macro so that the URL matches the <img> pre-catching tag at the bottom of the page
	loaderGif = '${CDN:%%appcore%%/mods/ThemePHC/images/fb-ajax-loader.gif}';
	</script>
	
	<!-- Board Tagline -->
	<!--<p class='board-tagline'><tmpl_var board_tagline></p>-->
	
	<!-- Board Description -->
	<!--<tmpl_if description>
		<div id='board-intro'>
			<tmpl_var board_description>
		</div>
	</tmpl_if>-->
	
	<!-- Removed: "print list" link and script -->
	
	<!-- Removed: "delete list" link and script -->
	
	<!-- "Add a post" link -->
	<!--<a class='new_link' href='%%bin%%/<tmpl_var board_folder_name>/new'><img src='%%appcore%%/images/silk/add.png' align=absmiddle border=0> Add a new post to this forum!</a>-->
	
	<script>
	
	function ajax_post_new(formElm)
	{
		var postData = {
			comment: formElm.text.value,
			poster_name: formElm.poster_name.value,
			poster_email: formElm.poster_email.value,
			output_fmt: "json",
			plain_text: 1
		};
		
		$("#post-placeholder").show();
		
		var errorFunc = function() 
		{
			$("#post-placeholder").hide();
			if(confirm("There was an error saving your post to the server - nothing was saved. Do you want to use the simple post page instead of this fancy page to make your post?"))
			{
				document.location.href = "%%binpath%%/%%board_folder_name%%/new?text=" + postData.text; 
			}
		}
		
		var postUrl = "%%binpath%%/%%board_folder_name%%/post";
		//alert(postUrl);
		$.ajax({
			type: "POST",
			url: postUrl,
			data: postData,
			success: function(data)
			{
				//alert("Got post data:"+data+", type:"+typeof(data));
				if(typeof(data) == "string")
				{
					// something wierd on server - should be JSON!
					errorFunc();
				}
				else
				{
					//alert(data);
					//console.debug(data);
					$("#post-tmpl").tmpl(data).insertAfter("#post-placeholder");
					$("#post-placeholder").hide();
					formElm.text.value = "";
					formElm.text.updateAutogrow();
					
					// Run onload scripts
					runOnloadScripts();
				}	
			},
			error: errorFunc
			
		});
		
		return false;
	}
	</script>
		
	<tmpl_if is_mobile>
		<table class='postlist' align=center cellspacing=0>
			<tbody>
				<tr class='post newpost'>
					<td valign='top' class='data' colspan=2>
						
						<form class='wrap'  onsubmit='return ajax_post_new(this)'>
							
							<table>
								<tr>
									<td>
										<img class='user_photo' src="http://www.gravatar.com/avatar/%%user_email_md5%%?d=$(CDN:<tmpl_if user_photo>%%user_photo%%<tmpl_else>%%appcore%%/mods/User/images/male-fb-sq-50px.jpg</tmpl_if>)&s=50" userid='%%user_userid%%' align=left>
									</td>
									<td colspan=2>
										<div class='content'>
											<textarea class='expandText' style="width:200px;height:5em" class="expandText" name="text"></textarea>
										</div>
									</td>
								<tmpl_if user_display>
								<tr>
									<td colspan=3>
										<div class='ident' id='postas_display'>
											Posting as <b>%%user_display%%</b>
										</div>
										<div class='controls'>
											<button type='submit' class='button'>Post</button>
										</div>
									</td>
								</tr>
								<tmpl_else>
									<tr>
										<td>Name:</td>
										<td><input value='%%user_display%%' name='poster_name' size=15></td>
									
										<td rowspan=2>
											<div class='controls'>
												<button type='submit' class='button'>Post</button>
											</div>
										</td>
									</tr>
									<tr>
										<td>Email:</td>
										<td><input value='%%user_email%%' name='poster_email' size=15></td>
									</tr>
								</tmpl_if>
							</table>
						
						</form>
					</td>
				</tr>
				<tmpl_if len>
					<tr class='post current_nums'>
						<td colspan=2>
							<div><span id='current_text'>Showing posts %%idx1%% - <span id='idx2'>%%idx2%%</span> of %%max_idx%% posts</span>
								<!--<tmpl_if next_idx>
									<span class=link>(<a class='loadmore_link' href='%%binpath%%/%%board_folder_name%%?idx=%%next_idx%%&len=%%len%%'>Load more posts ...</a><i class='loaded'></i>)</span>
								</tmpl_if>-->
							</div>
						</td>
					</tr>
				</tmpl_if>
				<tr class='post post-placeholder' id='post-placeholder'>
					<td valign='top' align='center' class='photo'>
						<img class='user_photo' src="${CDN:/appcore/mods/User/images/male-fb-sq-50px.jpg}" userid='%%user_uiserid%%'>
					</td>
					<td valign='top' class='data'>
						<img src='%%appcore%%/mods/ThemePHC/images/fb-ajax-loader.gif'>
					</td>
				</tr>
					
				<tmpl_loop posts>
					${inc:%%appcore%%/mods/ThemePHC/tmpl/boards/inc-postrow-mobile.tmpl}
				</tmpl_loop>
				
				<tmpl_if next_idx>
					<tr class='loadmore'>
						<td colspan=2 align=center>
							<a href='%%binpath%%/%%board_folder_name%%?idx=%%next_idx%%&len=%%len%%' id="load_more_bottom">Load more posts ...</a>
						</td>
					</tr>
				</tmpl_if>
			</tbody>
		</table>
	<tmpl_else>
		<table class='postlist' width='100%' align=center cellspacing=0>
			<tbody>
				<tr class='post newpost'>
					<td valign='top' align='center' class='photo'>
						<!--<img class='user_photo' src="${CDN:/appcore/mods/User/images/male-fb-sq-50px.jpg}">-->
						<img class='user_photo' src="http://www.gravatar.com/avatar/%%user_email_md5%%?d=$(CDN:<tmpl_if user_photo>%%user_photo%%<tmpl_else>%%appcore%%/mods/User/images/male-fb-sq-50px.jpg</tmpl_if>)&s=50" userid='%%user_userid%%'>
					</td>
					<td valign='top' class='data'>
						<form class='wrap'  onsubmit='return ajax_post_new(this)'>
							<div class='content'>
								<textarea class='expandText' style="width:99%;height:5em" class="expandText" name="text"></textarea>
								<!--<span><input type=radio name=category value=1 id=cat_1><label for=cat_1>Prayer</label></span>
								<span><input type=radio name=category value=2 id=cat_2><label for=cat_1>Praise!</label></span>
								<span><input type=checkbox name=is_epa value=1 id=is_epa><label for=is_epa>E-PrayerAlert</label></span>-->
							</div>
							<div class='controls'>
								<button type='submit' class='button'>Post</button>
							</div>
							<div class='form' id='postas_form'<tmpl_unless user_display> style='display:block'</tmpl_unless>>
								<table>
									<tr>
										<td>Name:</td>
										<td><input value='%%user_display%%' name='poster_name'></td>
									</tr>
									<tr>
										<td>Email:</td>
										<td><input value='%%user_email%%' name='poster_email'></td>
									</tr>
								</table>
							</div>
							<tmpl_if user_display>
								<div class='ident' id='postas_display'>
									<script>
									function show_postas_form()
									{
										$("#postas_form").show(200);
										$("#postas_display").hide(200);
									}
									</script>
									Posting as <b>%%user_display%%</b> - <a href='javascript:void(show_postas_form());'>Change</a>
								</div>
							</tmpl_if>
						</form>
					</td>
				</tr>
				<tmpl_if len>
					<tr class='post current_nums'>
						<td colspan=2>
							<div><span id='current_text'>Showing posts %%idx1%% - <span id='idx2'>%%idx2%%</span> of %%max_idx%% posts</span>
								<tmpl_if next_idx>
									<span class=link>(<a class='loadmore_link' href='%%binpath%%/%%board_folder_name%%?idx=%%next_idx%%&len=%%len%%'>Load more posts ...</a><i class='loaded'></i>)</span>
								</tmpl_if>
							</div>
						</td>
					</tr>
				</tmpl_if>
				<tr class='post post-placeholder' id='post-placeholder'>
					<td valign='top' align='center' class='photo'>
						<img class='user_photo' src="${CDN:/appcore/mods/User/images/male-fb-sq-50px.jpg}" userid='%%user_uiserid%%'>
					</td>
					<td valign='top' class='data'>
						<img src='%%appcore%%/mods/ThemePHC/images/fb-ajax-loader.gif'>
					</td>
				</tr>
					
				<tmpl_loop posts>
					${inc:%%appcore%%/mods/ThemePHC/tmpl/boards/inc-postrow.tmpl}
				</tmpl_loop>
				
				<tmpl_if next_idx>
					<tr class='loadmore'>
						<td colspan=2 align=center>
							<a href='%%binpath%%/%%board_folder_name%%?idx=%%next_idx%%&len=%%len%%' id="load_more_bottom">Load more posts ...</a>
						</td>
					</tr>
				</tmpl_if>
			</tbody>
		</table>
	</tmpl_if>
	
	<script>
	window.PagingNextIndex = %%next_idx%%;
	//loadmore_link
	var pagingLock = false;
	var pagingFunc = function(){
		
		if(pagingLock)
			return;
			
		pagingLock = true;
		
		if(!window.PagingNextIndex)
			return false;
			
		$("body").css("cursor", "progress");
			
		var th = $(this),
		    linkHref = th.attr("href"),
		    loadMoreUrl = '%%binpath%%/%%board_folder_name%%',
		    loading = $('<img/>')
		    	.attr('src',loaderGif)
		    	.attr('align','absmiddle');
		
		th.css("cursor", "progress");
		loading.insertAfter(th);
		
		// Hide just incase it's stil currently visible
		$('.current_nums i.loaded').hide();
		
		$.ajax({
			type: "GET",
			url: loadMoreUrl,
			data: 
			{
				idx: window.PagingNextIndex,
				len: %%len%%,
				output_fmt: 'json'
			},
			success: function(data)
			{
				//console.debug("got post data: "+data+", typeof: "+typeof(data));
				//alert("Got post data:"+data+", type:"+typeof(data));
				if(typeof(data) == "string")
				{
					// something wierd on server - should be JSON!
					document.location.href = linkHref;
					//alert("Got data as string");
				}
				else
				{
					// Iterate over the list of posts and reate the posts from the template
					var posts = data.posts;
					for(var i=0;i<posts.length;i++)
					{
						var postData = posts[i];
						$("#post-tmpl").tmpl(postData).insertBefore("tr.loadmore");
					}
					
					runOnloadScripts();
					
					loading.remove();
					
					var loaded = $('.current_nums i.loaded');
					loaded.show();
					//loaded.get()[0].innerHTML = "Loaded!";
					setTimeout(function() { loaded.hide(300) }, 3500);
					
					// Store the next index for the next time they request more posts
					window.PagingNextIndex = data.next_idx;
					
					// Update the number at the top of the page
					$("#idx2").html(data.idx2);
					
					// If we've reached the end, update the DOM
					if(!data.next_idx)
					{
						$("tr.loadmore a").html("(No more posts)");
						$("tr.loadmore a").addClass("not-a-link");
						$(".current_nums span.link").remove();
						$("#current_text").html("Showing all "+data.max_idx+" posts");
					}
					
					// Remove busy cursor
					$("body").css("cursor", "auto");
					th.css("cursor", "pointer");
					
					pagingLock = false;
				}	
			},
			error: function() 
			{ 
				//alert("Error");
				document.location.href = linkHref; 
			}
			
		});
		
		return false;
	}
	
	$(".loadmore a").live("click",pagingFunc);
	$("a.loadmore_link").live("click",pagingFunc);
	
	// Add a "load on scroll" method. 
	// This listens for the "onscroll" event and checks to see if the
	// bottom "Load more" link is visible at the bottom of the window.
	// As soon as the link gets close (see 'fudge'), then the 
	// paging function (above) is triggered just as if the user
	// had clicked the link
	$(window).bind('scroll', function(){
			
		var rowRef = $("tr.loadmore");
		var scrollBottom = $(window).scrollTop() + $(window).height();
		var fudge = 100; // amount by which to fudge the detection
		var rowTop = rowRef.offset().top - fudge; 
		if(rowTop < scrollBottom)
		{
			var domElm = rowRef.get()[0]; //document.getElementById("load_more_bottom");
			domElm.doPaging = pagingFunc;
			domElm.doPaging();
		}
	});
	
	
	</script>
	
	<tmpl_if is_mobile>
		<script id="post-tmpl" type="text/x-jquery-tmpl">
			${tmpl2jq:%%appcore%%/mods/ThemePHC/tmpl/boards/inc-postrow-mobile.tmpl}
		</script>
	<tmpl_else>
		<script id="post-tmpl" type="text/x-jquery-tmpl">
			${tmpl2jq:%%appcore%%/mods/ThemePHC/tmpl/boards/inc-postrow.tmpl}
		</script>
	</tmpl_if>

	
<script type="text/javascript">
$(function() {
	
	$('textarea').autogrow();
});
</script>

<tmpl_include inc-reply-scripts.tmpl>
<tmpl_include inc-video-scripts.tmpl>	

<script type="text/javascript" src="%%appcore%%/js/jquery-autogrow.js" index="50"></script>
<script type="text/javascript" src="%%appcore%%/js/jquery-scrollto.js" index="50"></script>
<script type="text/javascript" src="%%appcore%%/js/jquery.tmpl.js" index="50"></script>
<script type="text/javascript" src="%%appcore%%/mods/ThemePHC/js/boards-postlist-actions.js" index="50"></script>

<!-- Some browsers don't seem to load the loader gif until its actually visible - which causes visual artifacts
     when the "empty image" icon is shown, *then* the gif animation. By putting this image down here, initially
     visible then hiding it as soon as its loaded, we force the browser to preload the image inorder to reduce
     or prevent such visual artifcats. -->
<img src='%%appcore%%/mods/ThemePHC/images/fb-ajax-loader.gif' onload='this.style.display="none"'>

